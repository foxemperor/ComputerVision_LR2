import cv2
import numpy as np

def main():
    """
    –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç—Ä–µ–∫–∏–Ω–≥–∞ –∫—Ä–∞—Å–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞.
    –í—ã–ø–æ–ª–Ω—è–µ—Ç –≤—Å–µ 5 –∑–∞–¥–∞–Ω–∏–π –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–æ–π —Ä–∞–±–æ—Ç—ã.
    """

    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–∏–¥–µ–æ–ø–æ—Ç–æ–∫–∞ —Å –∫–∞–º–µ—Ä—ã
    cap = cv2.VideoCapture(0)

    if not cap.isOpened():
        print("‚ùå –û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –∫–∞–º–µ—Ä—É")
        print("–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã –∏ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞!")
        return
    
    print("‚úÖ –£—Å–ø–µ—à–Ω–æ: –∫–∞–º–µ—Ä–∞ –∑–∞–ø—É—â–µ–Ω–∞!")
    print("–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: 'q' –∏–ª–∏ 'ESC' –¥–ª—è –≤—ã—Ö–æ–¥–∞")
    print("–ü–æ–¥–Ω–µ—Å–∏—Ç–µ –∫—Ä–∞—Å–Ω—ã–π –æ–±—ä–µ–∫—Ç –∫ –∫–∞–º–µ—Ä–µ: üü•üëâüèªüì∑")

    # –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ –¥–ª—è –º–æ—Ä—Ñ–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
    # –†–∞–∑–º–µ—Ä —è–¥—Ä–∞ –≤–ª–∏—è–µ—Ç –Ω–∞ —Å—Ç–µ–ø–µ–Ω—å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
    kernel = np.ones((5, 5), np.uint8)
    
    # –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –ø–ª–æ—â–∞–¥—å –æ–±—ä–µ–∫—Ç–∞ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —à—É–º–∞
    min_area = 500
    
    # –ó–∞–¥–∞–Ω–∏–µ 1: –ó–∞—Ö–≤–∞—Ç –∫–∞–¥—Ä–∞ —Å –∫–∞–º–µ—Ä—ã
    while True:
        ret, frame = cap.read()
        
        if not ret:
            print("–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –∫–∞–¥—Ä–∞")
            break
        
        # –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –∏–∑ BGR –≤ HSV —Ü–≤–µ—Ç–æ–≤–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ
        # HSV —É–¥–æ–±–Ω–µ–µ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ü–≤–µ—Ç–æ–º, —Ç–∞–∫ –∫–∞–∫ Hue –æ—Ç–¥–µ–ª–µ–Ω –æ—Ç —è—Ä–∫–æ—Å—Ç–∏
        hsv = cv2.cvtColor(frame, cv2.COLOR_BGR2HSV)

    # –ó–∞–¥–∞–Ω–∏–µ 2: –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∫—Ä–∞—Å–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞
        # –ö—Ä–∞—Å–Ω—ã–π —Ü–≤–µ—Ç –∑–∞–Ω–∏–º–∞–µ—Ç –¥–≤–∞ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –Ω–∞ —à–∫–∞–ª–µ Hue (0-10 –∏ 170-180)
        # –≠—Ç–æ —Å–≤—è–∑–∞–Ω–æ —Å —Ç–µ–º, —á—Ç–æ –∫—Ä–∞—Å–Ω—ã–π –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –Ω–∞ –∫—Ä–∞—è—Ö —Å–ø–µ–∫—Ç—Ä–∞
        
        # –ù–∏–∂–Ω–∏–π –¥–∏–∞–ø–∞–∑–æ–Ω –∫—Ä–∞—Å–Ω–æ–≥–æ
        lower_red1 = np.array([0, 50, 50])
        upper_red1 = np.array([10, 255, 255])
        
        # –í–µ—Ä—Ö–Ω–∏–π –¥–∏–∞–ø–∞–∑–æ–Ω –∫—Ä–∞—Å–Ω–æ–≥–æ
        lower_red2 = np.array([170, 50, 50])
        upper_red2 = np.array([180, 255, 255])
        
        # –°–æ–∑–¥–∞–Ω–∏–µ –º–∞—Å–æ–∫ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞
        mask1 = cv2.inRange(hsv, lower_red1, upper_red1)
        mask2 = cv2.inRange(hsv, lower_red2, upper_red2)
        
        # –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –º–∞—Å–æ–∫ –ø–æ–±–∏—Ç–æ–≤–æ–π –æ–ø–µ—Ä–∞—Ü–∏–µ–π OR
        mask = cv2.bitwise_or(mask1, mask2)
        
    # –ó–∞–¥–∞–Ω–∏–µ 3: –ú–æ—Ä—Ñ–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è
        # –ú–æ—Ä—Ñ–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ —É–¥–∞–ª—è–µ—Ç –º–µ–ª–∫–∏–π —à—É–º (erosion -> dilation)
        opening = cv2.morphologyEx(mask, cv2.MORPH_OPEN, kernel, iterations=2)
        
        # –ú–æ—Ä—Ñ–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –∑–∞–ø–æ–ª–Ω—è–µ—Ç –¥—ã—Ä—ã –≤–Ω—É—Ç—Ä–∏ –æ–±—ä–µ–∫—Ç–æ–≤ (dilation -> erosion)
        closing = cv2.morphologyEx(opening, cv2.MORPH_CLOSE, kernel, iterations=2)
        
        # –ó–∞–¥–∞–Ω–∏–µ 4: –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –º–æ–º–µ–Ω—Ç–æ–≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        moments = cv2.moments(closing)
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –æ–±—ä–µ–∫—Ç –æ–±–Ω–∞—Ä—É–∂–µ–Ω (–ø–ª–æ—â–∞–¥—å –Ω–µ —Ä–∞–≤–Ω–∞ –Ω—É–ª—é)
        if moments["m00"] > min_area:
            # –ó–∞–¥–∞–Ω–∏–µ 5: –í—ã—á–∏—Å–ª–µ–Ω–∏–µ —Ü–µ–Ω—Ç—Ä–æ–∏–¥–∞ –∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–∞
            
            # –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç —Ü–µ–Ω—Ç—Ä–∞ –º–∞—Å—Å –æ–±—ä–µ–∫—Ç–∞
            # –§–æ—Ä–º—É–ª—ã: cx = M10/M00, cy = M01/M00
            cx = int(moments["m10"] / moments["m00"])
            cy = int(moments["m01"] / moments["m00"])
            
            # –ü–ª–æ—â–∞–¥—å –æ–±—ä–µ–∫—Ç–∞ (–º–æ–º–µ–Ω—Ç –Ω—É–ª–µ–≤–æ–≥–æ –ø–æ—Ä—è–¥–∫–∞)
            area = moments["m00"]
            
            # –ü–æ–∏—Å–∫ –∫–æ–Ω—Ç—É—Ä–æ–≤ –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—é—â–µ–≥–æ –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–∞
            contours, _ = cv2.findContours(closing, cv2.RETR_EXTERNAL, 
                                          cv2.CHAIN_APPROX_SIMPLE)
            
            if len(contours) > 0:
                # –í—ã–±–∏—Ä–∞–µ–º –∫–æ–Ω—Ç—É—Ä —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –ø–ª–æ—â–∞–¥—å—é
                largest_contour = max(contours, key=cv2.contourArea)
                
                # –ü–æ–ª—É—á–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏ —Ä–∞–∑–º–µ—Ä—ã –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—é—â–µ–≥–æ –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–∞
                x, y, w, h = cv2.boundingRect(largest_contour)
                
                # –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —á–µ—Ä–Ω–æ–≥–æ –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–∞ –≤–æ–∫—Ä—É–≥ –æ–±—ä–µ–∫—Ç–∞
                cv2.rectangle(frame, (x, y), (x + w, y + h), (0, 0, 0), 2)
                
                # –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ü–µ–Ω—Ç—Ä–∞ –æ–±—ä–µ–∫—Ç–∞ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
                cv2.circle(frame, (cx, cy), 5, (0, 255, 0), -1)
                
                # –í—ã–≤–æ–¥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–ª–æ—â–∞–¥–∏
                cv2.putText(frame, f"Area: {int(area)}", (x, y - 10),
                           cv2.FONT_HERSHEY_SIMPLEX, 0.6, (0, 0, 0), 2)
                
                # –í—ã–≤–æ–¥ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç —Ü–µ–Ω—Ç—Ä–∞
                cv2.putText(frame, f"Center: ({cx}, {cy})", (x, y + h + 20),
                           cv2.FONT_HERSHEY_SIMPLEX, 0.6, (0, 0, 0), 2)
        
        # –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –æ–∫–Ω–∞—Ö
        cv2.imshow('Original Frame', frame)
        cv2.imshow('HSV', hsv)
        cv2.imshow('Red Mask (Threshold)', mask)
        cv2.imshow('After Opening', opening)
        cv2.imshow('After Closing (Final)', closing)
        
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏–π –∫–ª–∞–≤–∏—à
        key = cv2.waitKey(1) & 0xFF
        if key == ord('q') or key == 27:  # 'q' –∏–ª–∏ ESC
            break
    
    # –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤
    cap.release()
    cv2.destroyAllWindows()
    print("–ü—Ä–æ–≥—Ä–∞–º–º–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞")

if __name__ == "__main__":
    main()
        